{% extends 'admin/master.html' %}
{% block body %}
<div class="container-fluid">
  <!-- Stats Cards -->
  <div class="row mb-4">
    <div class="col-6 col-md-4 col-lg-2 mb-3">
      <div class="card bg-primary text-white text-center h-100">
        <div class="card-body">
          <h3 class="card-title mb-0">{{ stats.users }}</h3>
          <p class="card-text mb-0">üë§ Users</p>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2 mb-3">
      <div class="card bg-success text-white text-center h-100">
        <div class="card-body">
          <h3 class="card-title mb-0">{{ stats.menus }}</h3>
          <p class="card-text mb-0">üìã Menus</p>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2 mb-3">
      <div class="card bg-info text-white text-center h-100">
        <div class="card-body">
          <h3 class="card-title mb-0">{{ stats.dishes }}</h3>
          <p class="card-text mb-0">üçΩÔ∏è Dishes</p>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2 mb-3">
      <div class="card bg-warning text-white text-center h-100">
        <div class="card-body">
          <h3 class="card-title mb-0">{{ stats.emotions }}</h3>
          <p class="card-text mb-0">üòä Emotions</p>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2 mb-3">
      <div class="card bg-secondary text-white text-center h-100">
        <div class="card-body">
          <h3 class="card-title mb-0">{{ stats.textures }}</h3>
          <p class="card-text mb-0">üß± Textures</p>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2 mb-3">
      <div class="card bg-dark text-white text-center h-100">
        <div class="card-body">
          <h3 class="card-title mb-0">{{ stats.shapes }}</h3>
          <p class="card-text mb-0">üî∑ Shapes</p>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8 mb-4">
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h5 class="mb-0">üìà API Usage (Last 7 Days)</h5>
        </div>
        <div class="card-body">
          <canvas id="usageChart" height="100"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-4 mb-4">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white">
          <h5 class="mb-0">‚ÑπÔ∏è Quick Info</h5>
        </div>
        <div class="card-body">
          <p><strong>Logged in as:</strong> {{ current_user.username }}</p>
          <p><strong>Role:</strong>
            {% if current_user.is_admin %}
              <span class="badge badge-danger">Admin</span>
            {% elif current_user.is_manager %}
              <span class="badge badge-warning">Manager</span>
            {% else %}
              <span class="badge badge-secondary">User</span>
            {% endif %}
          </p>
          <p><strong>Server time:</strong> <span id="server-time"></span></p>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-header bg-white">
      <h5 class="mb-0">üìù Recent API Activity</h5>
    </div>
    <div class="card-body p-0">
      {% if recent_logs %}
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="thead-light">
            <tr>
              <th>Time</th>
              <th>Method</th>
              <th>Endpoint</th>
              <th>User ID</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for log in recent_logs %}
            <tr>
              <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
              <td>
                {% if log.method == 'GET' %}
                  <span class="badge badge-success">{{ log.method }}</span>
                {% elif log.method == 'POST' %}
                  <span class="badge badge-primary">{{ log.method }}</span>
                {% elif log.method == 'DELETE' %}
                  <span class="badge badge-danger">{{ log.method }}</span>
                {% elif log.method == 'PUT' %}
                  <span class="badge badge-warning">{{ log.method }}</span>
                {% else %}
                  <span class="badge badge-secondary">{{ log.method }}</span>
                {% endif %}
              </td>
              <td><code>{{ log.endpoint }}</code></td>
              <td>{{ log.user_id or '-' }}</td>
              <td>
                {% if log.status_code < 300 %}
                  <span class="text-success font-weight-bold">{{ log.status_code }}</span>
                {% elif log.status_code < 500 %}
                  <span class="text-warning font-weight-bold">{{ log.status_code }}</span>
                {% else %}
                  <span class="text-danger font-weight-bold">{{ log.status_code }}</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="p-3">
        <p class="text-muted mb-0">No API activity yet.</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // API Usage Chart
  const ctx = document.getElementById('usageChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: {{ chart_labels | tojson }},
      datasets: [{
        label: 'API Requests',
        data: {{ chart_values | tojson }},
        borderColor: '#007bff',
        backgroundColor: 'rgba(0, 123, 255, 0.1)',
        fill: true,
        tension: 0.3,
        pointBackgroundColor: '#007bff',
        pointRadius: 5,
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { stepSize: 1 }
        }
      }
    }
  });

  // Server time
  document.getElementById('server-time').textContent = new Date().toLocaleString();
</script>
{% endblock %}
